version: '1.0'
steps:
  setup_build_image:
    type: build
    image_name: mtranter/aurelia-build-cv-home
    dockerfile: Dockerfile.build
    tag: latest
    build_arguments:
      - build_dir=${{main_clone}}
  aurelia_build:
    image: ${{setup_build_image}}
    working_directory: ${{main_clone}}/src
    description: Build Aurelia App
    commands:
      - mv /tmp/src/npm_modules ${{main_clone}}/src/
      - au build
  deploy:
    image: hashicorp/terraform
    working_directory: ${{main_clone}}/deploy
    description: Deploy using Terraform
    environment:
      - AWS_ACCESS_KEY_ID=${{AWS_ACCESS_KEY_ID}}
      - AWS_SECRET_ACCESS_KEY=${{AWS_SECRET_ACCESS_KEY}}
    commands:
      - terraform apply
